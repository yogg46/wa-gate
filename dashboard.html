<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - WhatsApp Gateway</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
      }

      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .navbar h1 {
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .navbar-right {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .btn-danger {
        background: rgba(220, 53, 69, 0.9);
        border-color: rgba(220, 53, 69, 1);
      }

      .btn-danger:hover {
        background: rgba(220, 53, 69, 1);
      }

      .container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
      }

      .stat-icon {
        font-size: 40px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
      }

      .stat-info {
        flex: 1;
      }

      .stat-label {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #333;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .card-icon {
        font-size: 32px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
      }

      .status-connected {
        background: #d4edda;
        color: #155724;
        animation: pulse-green 2s infinite;
      }

      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .status-loading {
        background: #fff3cd;
        color: #856404;
      }

      @keyframes pulse-green {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      #qr-img {
        width: 100%;
        max-width: 250px;
        border: 3px solid #667eea;
        border-radius: 10px;
        margin-top: 15px;
        display: none;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .qr-instructions {
        background: #e7f3ff;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 13px;
        color: #0c5a8a;
        display: none;
      }

      .qr-instructions.show {
        display: block;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        flex: 1;
        min-width: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .logs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .log-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .log-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .log-title h2 {
        font-size: 18px;
        color: #333;
      }

      .log-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .log-box {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 10px;
        height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .log-box::-webkit-scrollbar {
        width: 8px;
      }

      .log-box::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 10px;
      }

      .log-box::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
      }

      .log-line {
        margin-bottom: 4px;
      }

      .log-time {
        color: #9cdcfe;
      }

      .log-success {
        color: #00b894;
      }

      .log-error {
        color: #ff7675;
      }

      .log-warning {
        color: #fdcb6e;
      }

      .log-info {
        color: #81ecec;
      }

      .log-debug {
        color: #636e72;
      }

      .log-network {
        color: #74b9ff;
      }

      .log-security {
        color: #ff6b6b;
      }

      .log-queue {
        color: #a29bfe;
      }

      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        animation: slideIn 0.3s;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
        }
        to {
          transform: translateX(0);
        }
      }

      .toast.show {
        display: flex;
      }

      .toast.success {
        border-left: 4px solid #28a745;
      }

      .toast.error {
        border-left: 4px solid #dc3545;
      }

      .toast.warning {
        border-left: 4px solid #ffc107;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .metric-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
      }

      .metric-label {
        color: #666;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      .connection-details {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 13px;
      }

      .connection-details p {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
      }

      .connection-details strong {
        color: #333;
      }

      .connection-details span {
        color: #666;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      @media (max-width: 1200px) {
        .logs-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .stats-grid,
        .grid {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }

        .btn-primary {
          width: 100%;
        }

        .log-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .log-controls {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <h1>
        <span>üì±</span>
        WhatsApp Gateway Dashboard
      </h1>
      <div class="navbar-right">
        <a href="/broadcast" class="btn">üì§ Broadcast</a>
        <form method="POST" action="/logout" style="margin: 0">
          <button type="submit" class="btn btn-danger">üö™ Logout</button>
        </form>
      </div>
    </div>

    <div class="container">
      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üì®</div>
          <div class="stat-info">
            <div class="stat-label">Total Pesan</div>
            <div class="stat-value" id="totalMessages">-</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-info">
            <div class="stat-label">Pesan Terkirim</div>
            <div class="stat-value" id="sentMessages">-</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚ùå</div>
          <div class="stat-info">
            <div class="stat-label">Pesan Gagal</div>
            <div class="stat-value" id="failedMessages">-</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-info">
            <div class="stat-label">Antrian</div>
            <div class="stat-value" id="queueLength">-</div>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Connection Status Card -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üîå</span>
            <div>
              <div class="card-title">Status Koneksi WhatsApp</div>
            </div>
          </div>
          <div id="status" class="status-badge status-loading">
            <span class="loading"></span> Mengecek status...
          </div>
          <img id="qr-img" alt="QR Code" />
          <div id="qr-instructions" class="qr-instructions">
            üì± <strong>Cara Scan QR Code:</strong><br />
            1. Buka WhatsApp di ponsel Anda<br />
            2. Ketuk Menu atau Settings<br />
            3. Pilih "WhatsApp Web"<br />
            4. Scan kode QR di atas
          </div>

          <div
            class="connection-details"
            id="connectionDetails"
            style="display: none"
          >
            <p>
              <strong>Last Connected:</strong> <span id="lastConnected">-</span>
            </p>
            <p>
              <strong>Reconnect Attempts:</strong>
              <span id="reconnectAttempts">-</span>
            </p>
            <p>
              <strong>Total Messages Received:</strong>
              <span id="totalReceived">-</span>
            </p>
            <p><strong>Error Count:</strong> <span id="errorCount">-</span></p>
          </div>
        </div>

        <!-- Control Panel Card -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">‚öôÔ∏è</span>
            <div>
              <div class="card-title">Kontrol Gateway</div>
            </div>
          </div>
          <div class="action-buttons">
            <button id="restart-btn" class="btn-primary">üîÑ Restart</button>
            <button id="refresh-btn" class="btn-primary">‚ôªÔ∏è Refresh</button>
          </div>
          <div class="action-buttons">
            <button id="health-btn" class="btn-primary">üè• Health Check</button>
            <button id="metrics-btn" class="btn-primary">üìä Metrics</button>
          </div>
        </div>

        <!-- System Info Card -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üíª</span>
            <div>
              <div class="card-title">Informasi Sistem</div>
            </div>
          </div>
          <div class="metrics-grid" id="systemMetrics">
            <div class="metric-item">
              <div class="metric-label">Uptime</div>
              <div class="metric-value" id="uptime">-</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Memory Usage</div>
              <div class="metric-value" id="memoryUsage">-</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Node Version</div>
              <div class="metric-value" id="nodeVersion">-</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">CPU Cores</div>
              <div class="metric-value" id="cpuCores">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dual Log Containers -->
      <div class="logs-grid">
        <!-- Activity Log -->
        <div class="log-container">
          <div class="log-header">
            <div class="log-title">
              <span style="font-size: 24px">üìã</span>
              <div>
                <h2>Log Aktivitas</h2>
                <p style="font-size: 12px; color: #666; margin-top: 3px">
                  Auto refresh ‚Ä¢ Last: <span id="activityLastUpdate">-</span>
                </p>
              </div>
            </div>
            <div class="log-controls">
              <button class="btn btn-small" id="clearActivityBtn">üóëÔ∏è</button>
              <button class="btn btn-small" id="downloadActivityBtn">üíæ</button>
            </div>
          </div>
          <div id="activityLog" class="log-box">Memuat log aktivitas...</div>
        </div>

        <!-- Network Log -->
        <div class="log-container">
          <div class="log-header">
            <div class="log-title">
              <span style="font-size: 24px">üåê</span>
              <div>
                <h2>Log Network</h2>
                <p style="font-size: 12px; color: #666; margin-top: 3px">
                  Auto refresh ‚Ä¢ Last: <span id="networkLastUpdate">-</span>
                </p>
              </div>
            </div>
            <div class="log-controls">
              <button class="btn btn-small" id="clearNetworkBtn">üóëÔ∏è</button>
              <button class="btn btn-small" id="downloadNetworkBtn">üíæ</button>
            </div>
          </div>
          <div id="networkLog" class="log-box">Memuat log network...</div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <span id="toastIcon"></span>
      <span id="toastMessage"></span>
    </div>

    <script>
      let API_KEY = '{{LARAVEL_API_KEY}}';
      let autoRefreshInterval;
      let metricsInterval;

      // Toast notification function
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const msg = document.getElementById('toastMessage');

        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è',
        };

        icon.textContent = icons[type] || icons.info;
        msg.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
          toast.classList.remove('show');
        }, 4000);
      }

      // Validate API Key
      function validateApiKey() {
        if (
          !API_KEY ||
          API_KEY === '{{LARAVEL_API_KEY}}' ||
          API_KEY === 'undefined' ||
          API_KEY.length < 10
        ) {
          console.error('‚ùå API Key tidak valid');
          showToast(
            'API Key tidak valid. Silakan logout dan login kembali.',
            'error'
          );
          return false;
        }
        console.log('‚úÖ API Key valid');
        return true;
      }

      // Fetch QR Code
      async function fetchQR() {
        const imgEl = document.getElementById('qr-img');
        const statusEl = document.getElementById('status');
        const instructions = document.getElementById('qr-instructions');

        try {
          const res = await fetch('/qr', {
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          if (data.status && data.qr) {
            imgEl.src = data.qr;
            imgEl.style.display = 'block';
            instructions.classList.add('show');
            statusEl.className = 'status-badge status-loading';
            statusEl.innerHTML = 'üì∏ QR Code tersedia - Silakan scan';
          } else {
            imgEl.style.display = 'none';
            instructions.classList.remove('show');
            statusEl.className = 'status-badge status-connected';
            statusEl.innerHTML = '‚úÖ WhatsApp Terhubung';
            document.getElementById('connectionDetails').style.display =
              'block';
          }
        } catch (err) {
          statusEl.className = 'status-badge status-disconnected';
          statusEl.innerHTML = '‚ùå Tidak terhubung';
          imgEl.style.display = 'none';
          instructions.classList.remove('show');
          console.error('Error fetching QR:', err);
        }
      }

      // Fetch Activity Log Only
      async function fetchActivityLog() {
        try {
          const res = await fetch('/logs/activity?lines=200', {
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          const activityLog = document.getElementById('activityLog');

          if (data.status && data.log) {
            const lines = data.log.trim().split('\n');
            const reversed = lines.reverse(); // Show latest first
            activityLog.innerHTML = formatLog(reversed.join('\n'));
          } else {
            activityLog.innerHTML =
              '<div class="log-line log-warning">üìù Belum ada log aktivitas hari ini</div>';
          }

          // Update last update time
          const now = new Date().toLocaleTimeString('id-ID');
          document.getElementById('activityLastUpdate').textContent = now;

          // Auto scroll to top (showing latest)
          activityLog.scrollTop = 0;

          return true;
        } catch (err) {
          console.error('Error fetching activity log:', err);
          document.getElementById('activityLog').innerHTML =
            '<div class="log-line log-error">‚ùå Gagal memuat log aktivitas</div>';
          return false;
        }
      }

      // Fetch Network Log Only
      async function fetchNetworkLog() {
        try {
          const res = await fetch('/logs/network?lines=200', {
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          const networkLog = document.getElementById('networkLog');

          if (data.status && data.log) {
            const lines = data.log.trim().split('\n');
            const reversed = lines.reverse(); // Show latest first
            networkLog.innerHTML = formatLog(reversed.join('\n'), true);
          } else {
            networkLog.innerHTML =
              '<div class="log-line log-warning">üåê Belum ada log network hari ini</div>';
          }

          // Update last update time
          const now = new Date().toLocaleTimeString('id-ID');
          document.getElementById('networkLastUpdate').textContent = now;

          // Auto scroll to top (showing latest)
          networkLog.scrollTop = 0;

          return true;
        } catch (err) {
          console.error('Error fetching network log:', err);
          document.getElementById('networkLog').innerHTML =
            '<div class="log-line log-error">‚ùå Gagal memuat log network</div>';
          return false;
        }
      }

      // Enhanced log formatting
      function formatLog(logText, isNetwork = false) {
        if (!logText)
          return '<div class="log-line log-warning">Tidak ada log</div>';

        const lines = logText.split('\n').filter((line) => line.trim());

        return lines
          .map((line) => {
            let className = 'log-info';

            // Color coding based on content
            if (line.includes('[ERROR]') || line.includes('‚ùå')) {
              className = 'log-error';
            } else if (line.includes('[WARN]') || line.includes('‚ö†Ô∏è')) {
              className = 'log-warning';
            } else if (line.includes('[SUCCESS]') || line.includes('‚úÖ')) {
              className = 'log-success';
            } else if (line.includes('[NETWORK]') || line.includes('üåê')) {
              className = 'log-network';
            } else if (line.includes('[DEBUG]') || line.includes('üîç')) {
              className = 'log-debug';
            } else if (line.includes('[SECURITY]') || line.includes('üîê')) {
              className = 'log-security';
            } else if (line.includes('[QUEUE]') || line.includes('üìä')) {
              className = 'log-queue';
            }

            // Extract timestamp and message
            const timeMatch = line.match(/\[(.*?)\]/);
            if (timeMatch && timeMatch.index === 0) {
              const time = timeMatch[1];
              const message = line.substring(timeMatch[0].length).trim();
              return `<div class="log-line"><span class="log-time">[${time}]</span> <span class="${className}">${message}</span></div>`;
            }

            return `<div class="log-line ${className}">${line}</div>`;
          })
          .join('');
      }

      // Fetch metrics
      async function fetchMetrics() {
        try {
          const res = await fetch('/metrics', {
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          // Update stats
          document.getElementById('totalMessages').textContent =
            data.connection.totalMessages || 0;
          document.getElementById('sentMessages').textContent =
            data.messageQueue.sent || 0;
          document.getElementById('failedMessages').textContent =
            data.messageQueue.failed || 0;
          document.getElementById('queueLength').textContent =
            data.messageQueue.queueLength || 0;


          // Update connection details
          if (data.connection.lastConnected) {
            document.getElementById('lastConnected').textContent = new Date(
              data.connection.lastConnected
            ).toLocaleString('id-ID');
          }
          document.getElementById('reconnectAttempts').textContent =
            data.connection.reconnectAttempts || 0;
          document.getElementById('totalReceived').textContent =
            data.connection.totalMessages || 0;
          document.getElementById('errorCount').textContent =
            data.connection.errors || 0;
        } catch (err) {
          console.error('Error fetching metrics:', err);
        }
      }

      // Fetch health check
      async function fetchHealth() {
        try {
          const res = await fetch('/health');
          const data = await res.json();

          // Update system info
          document.getElementById('uptime').textContent =
            data.uptime.formatted || '-';
          document.getElementById('memoryUsage').textContent =
            data.memory.heapUsed || '-';
          document.getElementById('nodeVersion').textContent =
            data.system.nodeVersion || '-';
          document.getElementById('cpuCores').textContent =
            data.system.cpuCount || '-';

          showToast('Health check berhasil', 'success');
        } catch (err) {
          showToast('Gagal melakukan health check', 'error');
          console.error('Error fetching health:', err);
        }
      }

      // Download specific log
      async function downloadLog(type, filename) {
        try {
          const endpoint =
            type === 'network' ? '/logs/network' : '/logs/activity';
          const res = await fetch(endpoint + '?lines=5000', {
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          if (data.status && data.log) {
            const blob = new Blob([data.log], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const today = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `${filename}-${today}.log`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showToast(
              `${filename} berhasil didownload (${
                data.log.split('\n').length
              } lines)`,
              'success'
            );
          } else {
            showToast('Tidak ada data log untuk didownload', 'warning');
          }
        } catch (err) {
          showToast('Gagal mendownload log: ' + err.message, 'error');
        }
      }

      // Clear log display
      function clearLogDisplay(logId, logName) {
        if (
          confirm(`Clear tampilan ${logName}? (Log tetap tersimpan di server)`)
        ) {
          document.getElementById(
            logId
          ).innerHTML = `<div class="log-line log-info">‚ÑπÔ∏è Tampilan ${logName} dibersihkan. Refresh untuk memuat ulang.</div>`;
          showToast(`Tampilan ${logName} dibersihkan`, 'info');
        }
      }

      // Restart gateway
      async function restartGateway() {
        if (
          !confirm(
            '‚ö†Ô∏è Yakin ingin restart gateway? Koneksi WhatsApp akan terputus sementara.'
          )
        )
          return;

        const btn = document.getElementById('restart-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Restarting...';

        try {
          const res = await fetch('/restart', {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + API_KEY },
          });
          const data = await res.json();

          if (data.status) {
            showToast(
              'Gateway sedang direstart. Tunggu 10 detik...',
              'success'
            );

            // Wait and refresh page
            setTimeout(() => {
              window.location.reload();
            }, 10000);
          } else {
            showToast('Gagal restart: ' + data.message, 'error');
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Restart';
          }
        } catch (err) {
          showToast('Gagal restart: ' + err.message, 'error');
          btn.disabled = false;
          btn.innerHTML = 'üîÑ Restart';
        }
      }

      // Refresh all data
      function refreshAll() {
        showToast('Memuat ulang data...', 'info');
        fetchQR();
        fetchActivityLog();
        fetchNetworkLog();
        fetchMetrics();
        fetchHealth();
      }

      // Event listeners
      document
        .getElementById('restart-btn')
        .addEventListener('click', restartGateway);
      document
        .getElementById('refresh-btn')
        .addEventListener('click', refreshAll);
      document
        .getElementById('health-btn')
        .addEventListener('click', fetchHealth);
      document.getElementById('metrics-btn').addEventListener('click', () => {
        fetchMetrics();
        showToast('Metrics updated', 'success');
      });

      // Activity log controls
      document
        .getElementById('clearActivityBtn')
        .addEventListener('click', () => {
          clearLogDisplay('activityLog', 'Log Aktivitas');
        });
      document
        .getElementById('downloadActivityBtn')
        .addEventListener('click', () => {
          downloadLog('activity', 'activity-log');
        });

      // Network log controls
      document
        .getElementById('clearNetworkBtn')
        .addEventListener('click', () => {
          clearLogDisplay('networkLog', 'Log Network');
        });
      document
        .getElementById('downloadNetworkBtn')
        .addEventListener('click', () => {
          downloadLog('network', 'network-log');
        });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + R - Refresh
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
          e.preventDefault();
          refreshAll();
        }
      });

      // Initialize dashboard
      (function init() {
        console.log('üöÄ Dashboard Initialization...');

        // Validate API Key
        if (!validateApiKey()) {
          document.getElementById('status').innerHTML = '‚ùå Konfigurasi Error';
          document.getElementById('status').className =
            'status-badge status-disconnected';
          document.getElementById('activityLog').innerHTML =
            '<div class="log-line log-error">‚ùå API Key tidak valid. Silakan logout dan login kembali.</div>';
          document.getElementById('networkLog').innerHTML =
            '<div class="log-line log-error">‚ùå API Key tidak valid.</div>';

          // Disable all buttons
          document.getElementById('restart-btn').disabled = true;
          document.getElementById('refresh-btn').disabled = true;
          document.getElementById('health-btn').disabled = true;
          document.getElementById('metrics-btn').disabled = true;
          return;
        }

        // Load initial data
        console.log('üìä Loading initial data...');
        fetchQR();
        fetchActivityLog();
        fetchNetworkLog();
        fetchMetrics();
        fetchHealth();

        // Auto refresh QR and Logs every 10 seconds
        autoRefreshInterval = setInterval(() => {
          fetchQR();
          fetchActivityLog();
          fetchNetworkLog();
        }, 10000);

        // Update metrics every 5 seconds
        metricsInterval = setInterval(() => {
          fetchMetrics();
        }, 5000);

        console.log('‚úÖ Dashboard initialized successfully');
        showToast('Dashboard berhasil dimuat', 'success');
      })();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        if (metricsInterval) clearInterval(metricsInterval);
      });

      // Visibility change handling (pause refresh when tab not visible)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          console.log('‚è∏Ô∏è Tab hidden - Pausing auto refresh');
          if (autoRefreshInterval) clearInterval(autoRefreshInterval);
          if (metricsInterval) clearInterval(metricsInterval);
        } else {
          console.log('‚ñ∂Ô∏è Tab visible - Resuming auto refresh');
          // Resume auto refresh
          fetchQR();
          fetchActivityLog();
          fetchNetworkLog();
          fetchMetrics();

          autoRefreshInterval = setInterval(() => {
            fetchQR();
            fetchActivityLog();
            fetchNetworkLog();
          }, 10000);

          metricsInterval = setInterval(() => {
            fetchMetrics();
          }, 5000);
        }
      });

      // Connection status check
      let connectionCheckInterval = setInterval(async () => {
        try {
          const res = await fetch('/health');
          if (!res.ok) {
            showToast('Koneksi ke server terputus', 'error');
          }
        } catch (err) {
          showToast('Tidak dapat terhubung ke server', 'error');
          console.error('Connection check failed:', err);
        }
      }, 30000); // Check every 30 seconds

      // Cleanup connection check
      window.addEventListener('beforeunload', () => {
        if (connectionCheckInterval) clearInterval(connectionCheckInterval);
      });
    </script>
  </body>
</html>
