<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WhatsApp Gateway</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(220, 53, 69, 0.9);
            border-color: rgba(220, 53, 69, 1);
        }

        .btn-danger:hover {
            background: rgba(220, 53, 69, 1);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 32px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
        }

        #qr-img {
            width: 100%;
            max-width: 250px;
            border: 3px solid #667eea;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #log::-webkit-scrollbar {
            width: 8px;
        }

        #log::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }

        #log::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .log-line {
            margin-bottom: 4px;
        }

        .log-time {
            color: #9cdcfe;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-warning {
            color: #dcdcaa;
        }

        .log-info {
            color: #569cd6;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1;
            margin-top: 5px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f5f7fa;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>
            <span>üì±</span>
            WhatsApp Gateway Dashboard
        </h1>
        <div class="navbar-right">
            <a href="/broadcast" class="btn">üì§ Broadcast</a>
            <form method="POST" action="/logout" style="margin: 0">
                <button type="submit" class="btn btn-danger">üö™ Logout</button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üîå</span>
                    <div>
                        <div class="card-title">Status Koneksi</div>
                    </div>
                </div>
                <div id="status" class="status-badge status-loading">
                    <span class="loading"></span> Mengecek status...
                </div>
                <img id="qr-img" alt="QR Code">
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚öôÔ∏è</span>
                    <div>
                        <div class="card-title">Kontrol Gateway</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="restart-btn" class="btn-primary">
                        üîÑ Restart Gateway
                    </button>
                    <button id="refresh-btn" class="btn-primary">
                        ‚ôªÔ∏è Refresh
                    </button>
                </div>
            </div>
        </div>

        <div class="log-container">
            <div class="log-header">
                <div>
                    <h2 style="font-size: 20px; color: #333">üìã Log Aktivitas</h2>
                    <p style="font-size: 13px; color: #666; margin-top: 5px">
                        Log hari ini - Auto refresh setiap 10 detik
                    </p>
                </div>
                <div class="dropdown">
                    <button class="btn" id="logMenuBtn">üìÅ Riwayat Log</button>
                    <div class="dropdown-content" id="logDropdown"></div>
                </div>
            </div>
            <div id="log">Memuat log...</div>
        </div>
    </div>

    <script>
        let API_KEY = '{{LARAVEL_API_KEY}}';
        let autoRefreshInterval;

        // Validasi API Key dari server-side rendering
        function validateApiKey() {
            if (!API_KEY || API_KEY === '{{LARAVEL_API_KEY}}' || API_KEY === 'undefined' || API_KEY.length < 10) {
                console.error('‚ùå API Key tidak valid dari server');
                return false;
            }
            console.log('‚úÖ API Key valid:', API_KEY.substring(0, 15) + '...');
            return true;
        }

        async function fetchQR() {
            const imgEl = document.getElementById('qr-img');
            const statusEl = document.getElementById('status');
            try {
                const res = await fetch('/qr', {
                    headers: { Authorization: 'Bearer ' + API_KEY }
                });
                const data = await res.json();
                if (data.status && data.qr) {
                    imgEl.src = data.qr;
                    imgEl.style.display = 'block';
                    statusEl.className = 'status-badge status-loading';
                    statusEl.innerHTML = 'üì∏ QR tersedia, silakan scan di WhatsApp';
                } else {
                    imgEl.style.display = 'none';
                    statusEl.className = 'status-badge status-connected';
                    statusEl.innerHTML = '‚úÖ WhatsApp terhubung';
                }
            } catch (err) {
                statusEl.className = 'status-badge status-disconnected';
                statusEl.innerHTML = '‚ùå Gagal mengambil status';
                imgEl.style.display = 'none';
            }
        }

        function formatLog(logText) {
            const lines = logText.split('\n');
            return lines.map(line => {
                let className = '';
                if (line.includes('‚úÖ') || line.includes('berhasil')) className = 'log-success';
                else if (line.includes('‚ùå') || line.includes('Gagal')) className = 'log-error';
                else if (line.includes('‚ö†Ô∏è') || line.includes('warning')) className = 'log-warning';
                else if (line.includes('üì∏') || line.includes('üì©') || line.includes('üì®')) className = 'log-info';

                const timeMatch = line.match(/\[(.*?)\]/);
                if (timeMatch) {
                    const time = timeMatch[1];
                    const message = line.substring(timeMatch[0].length).trim();
                    return `<div class="log-line"><span class="log-time">[${time}]</span> <span class="${className}">${message}</span></div>`;
                }
                return `<div class="log-line ${className}">${line}</div>`;
            }).join('');
        }

        async function fetchLog() {
            const logEl = document.getElementById('log');
            try {
                const res = await fetch('/logs', {
                    headers: { Authorization: 'Bearer ' + API_KEY }
                });
                const data = await res.json();
                if (data.log) {
                    const lines = data.log.trim().split('\n').reverse();
                    logEl.innerHTML = formatLog(lines.join('\n'));
                } else {
                    logEl.innerHTML = '<div class="log-line log-warning">üìù Belum ada log hari ini</div>';
                }
            } catch (err) {
                logEl.innerHTML = `<div class="log-line log-error">‚ùå Gagal memuat log: ${err.message}</div>`;
            }
        }

        async function loadLogHistory() {
            try {
                const res = await fetch('/logs/list', {
                    headers: { Authorization: 'Bearer ' + API_KEY }
                });
                const data = await res.json();
                const dropdown = document.getElementById('logDropdown');

                if (data.status && data.logs.length > 0) {
                    dropdown.innerHTML = data.logs.map(log =>
                        `<div class="dropdown-item" onclick="downloadLog('${log.date}')">
                            üìÑ ${log.date} (${(log.size / 1024).toFixed(2)} KB)
                        </div>`
                    ).join('');
                } else {
                    dropdown.innerHTML = '<div class="dropdown-item">Tidak ada riwayat log</div>';
                }
            } catch (err) {
                console.error('Gagal load log history:', err);
            }
        }

        function downloadLog(date) {
            fetch(`/logs/download/${date}`, {
                headers: { Authorization: 'Bearer ' + API_KEY }
            })
            .then(response => {
                if (!response.ok) throw new Error('Gagal download log');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gateway-${date}.log`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                alert('Gagal download log: ' + err.message);
            });

            document.getElementById('logDropdown').classList.remove('show');
        }

        async function restartGateway() {
            if (!confirm('Yakin ingin restart gateway?')) return;
            const btn = document.getElementById('restart-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Restarting...';

            try {
                const res = await fetch('/restart', {
                    method: 'POST',
                    headers: { Authorization: 'Bearer ' + API_KEY }
                });
                const data = await res.json();
                alert(data.message);
            } catch (err) {
                alert('Gagal restart: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Restart Gateway';
            }
        }

        function refreshAll() {
            fetchQR();
            fetchLog();
        }

        // Event listeners
        document.getElementById('restart-btn').addEventListener('click', restartGateway);
        document.getElementById('refresh-btn').addEventListener('click', refreshAll);

        document.getElementById('logMenuBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('logDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                loadLogHistory();
            }
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', () => {
            document.getElementById('logDropdown').classList.remove('show');
        });

        // Initialize - Load initial data
        (function init() {
            // Validasi API Key dari server
            if (!validateApiKey()) {
                document.getElementById('status').innerHTML = '‚ùå Gagal memuat konfigurasi';
                document.getElementById('status').className = 'status-badge status-disconnected';
                document.getElementById('log').innerHTML = '<div class="log-line log-error">‚ùå Gagal memuat API Key. Silakan logout dan login kembali.</div>';
                return;
            }

            // Load initial data
            fetchQR();
            fetchLog();

            // Auto refresh every 10 seconds
            autoRefreshInterval = setInterval(() => {
                fetchQR();
                fetchLog();
            }, 10000);
        })();
    </script>
</body>
</html>